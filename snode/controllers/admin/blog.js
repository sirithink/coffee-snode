// Generated by CoffeeScript 1.6.2
var config, dateUtil, db, dbCache, log, logentries;

dateUtil = require('../../util/dateUtil');

logentries = require('node-logentries');

dbCache = require('../../dao/cache').dbCache;

db = require('../../dao/db').db;

config = require('../../config');

log = logentries.logger(config.logToken);

/*
  跳转到写博
*/


exports.getAdd = function(req, res) {
  return res.render('admin/blog-add', {
    title: 'snode写博'
  });
};

/*
  保存文章
*/


exports.postAdd = function(req, res) {
  var blog;

  blog = req.body.blog;
  blog.create_time = dateUtil.time();
  blog.update_time = dateUtil.time();
  blog.user_id = 1;
  console.log("Add:\t" + blog.title);
  log.log("debug", "Add:\t" + blog.title);
  return db.insert('blog', blog, function(error, data) {
    log.info(error || data);
    dbCache.reload();
    return res.render('admin/blog-add', {
      title: 'snode写博'
    });
  });
};

/*
  跳转到编辑
*/


exports.getEdit = function(req, res) {
  return db.findById('blog', req.params.id, function(error, data) {
    if (error) {
      log.info(error);
    }
    return res.render('admin/blog-edit', {
      title: 'snode博客编辑',
      blog: data[0]
    });
  });
};

/*
  跟新文章
*/


exports.postEdit = function(req, res) {
  var blog;

  blog = req.body.blog;
  blog.update_time = dateUtil.time();
  console.log("Updata:\t" + blog.title + "\ttime:" + blog.update_time);
  log.log("debug", "Updata:\t" + blog.title);
  return db.update('blog', blog, {
    id: blog.id
  }, function(error, data) {
    log.info(error || data);
    dbCache.reload();
    return res.redirect('admin/index');
  });
};
